name: Docker Deploy to JCloud

on:
  # main ë¸Œëœì¹˜ì— ì§ì ‘ push ì‹œ íŠ¸ë¦¬ê±°
  push:
    branches: [ main ]
  
  # PRì´ main ë¸Œëœì¹˜ì— ë¨¸ì§€(closed + merged)ë  ë•Œ íŠ¸ë¦¬ê±°
  pull_request:
    branches: [ main ]
    types: [ closed ]
  
  # ìˆ˜ë™ ì‹¤í–‰ (GitHub Actions íƒ­ì—ì„œ Run workflow ë²„íŠ¼)
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'ìºì‹œ ë¬´ì‹œí•˜ê³  ì™„ì „ ì¬ë¹Œë“œ'
        required: false
        default: false
        type: boolean

# ë™ì‹œ ë°°í¬ ë°©ì§€ (ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œëŠ” ìˆœì°¨ ì‹¤í–‰)
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    # PRì´ ë¨¸ì§€ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (closedì´ì§€ë§Œ mergedê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. ë°°í¬ ì‹œì‘ ì•Œë¦¼
    - name: ğŸš€ ë°°í¬ ì‹œì‘
      run: |
        echo "========================================="
        echo "ğŸš€ JCloud ë°°í¬ ì‹œì‘"
        echo "========================================="
        echo "ğŸ“Œ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        echo "ğŸ“Œ ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ğŸ“Œ ì»¤ë°‹: ${{ github.sha }}"
        echo "ğŸ“Œ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
        echo "========================================="
    
    # 3. SSHë¥¼ í†µí•œ JCloud ë°°í¬
    - name: ğŸ”§ JCloud ì„œë²„ì— SSH ì ‘ì† ë° ë°°í¬
      uses: appleboy/ssh-action@v1.0.3
      env:
        FORCE_REBUILD: ${{ github.event.inputs.force_rebuild || 'false' }}
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: ${{ secrets.VM_PORT }}
        timeout: 300s
        command_timeout: 20m
        envs: FORCE_REBUILD
        script: |
          set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          
          # í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
          PROJECT_DIR="$HOME/frontend/JBNU-COE.github.io"
          
          echo "========================================="
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì •"
          echo "========================================="
          
          # frontend ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)
          mkdir -p "$HOME/frontend"
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ -d "$PROJECT_DIR" ]; then
            echo "âœ… ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ë°œê²¬"
            cd "$PROJECT_DIR"
          else
            echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í´ë¡ í•©ë‹ˆë‹¤..."
            cd "$HOME/frontend"
            
            # í˜¹ì‹œ ë””ë ‰í† ë¦¬ë§Œ ìˆê³  .gitì´ ì—†ëŠ” ê²½ìš° ì‚­ì œ
            if [ -d "JBNU-COE.github.io" ]; then
              echo "âš ï¸ ë¶ˆì™„ì „í•œ ë””ë ‰í† ë¦¬ ë°œê²¬, ì‚­ì œ í›„ ì¬í´ë¡ ..."
              rm -rf JBNU-COE.github.io
            fi
            
            git clone https://github.com/${{ github.repository }}.git JBNU-COE.github.io
            cd JBNU-COE.github.io
          fi
          
          echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(pwd)"
          
          echo "========================================="
          echo "ğŸ“¥ Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
          echo "========================================="
          git fetch origin main
          git reset --hard origin/main
          git clean -fd
          
          echo "í˜„ì¬ ì»¤ë°‹: $(git log -1 --oneline)"
          
          echo "========================================="
          echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •"
          echo "========================================="
          # .env íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
          cat > .env << 'EOF'
          REACT_APP_NAVER_CLIENT_ID=${{ secrets.REACT_APP_NAVER_CLIENT_ID }}
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
          EOF
          
          echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"
          
          echo "========================================="
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ë°°í¬"
          echo "========================================="
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€..."
          docker compose down --remove-orphans 2>/dev/null || true
          
          # ê°•ì œ ì¬ë¹Œë“œ ì˜µì…˜ í™•ì¸
          if [ "$FORCE_REBUILD" = "true" ]; then
            echo "ğŸ”„ ê°•ì œ ì¬ë¹Œë“œ ëª¨ë“œ: ìºì‹œ ë¬´ì‹œ"
            docker compose build --no-cache
          fi
          
          # ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
          echo "ğŸš€ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘..."
          docker compose up -d --build --force-recreate
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
          echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 10
          
          echo "========================================="
          echo "âœ… ë°°í¬ ìƒíƒœ í™•ì¸"
          echo "========================================="
          docker compose ps
          
          # í—¬ìŠ¤ì²´í¬
          echo ""
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
          for i in {1..6}; do
            if curl -sf http://localhost:80 > /dev/null 2>&1; then
              echo "âœ… ì„œë²„ ì‘ë‹µ ì •ìƒ (ì‹œë„ $i/6)"
              break
            else
              echo "â³ ì„œë²„ ì‘ë‹µ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/6)"
              sleep 5
            fi
            
            if [ $i -eq 6 ]; then
              echo "âš ï¸ ì„œë²„ ì‘ë‹µ ì§€ì—° - ë¡œê·¸ í™•ì¸ í•„ìš”"
            fi
          done
          
          echo ""
          echo "========================================="
          echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ (50ì¤„)"
          echo "========================================="
          docker compose logs --tail=50
          
          echo ""
          echo "========================================="
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "========================================="
          
          # ì˜¤ë˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬ (ì„ íƒì )
          echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬..."
          docker image prune -f 2>/dev/null || true
    
    # 4. ë°°í¬ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "========================================="
        echo "ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½"
        echo "========================================="
        echo "ìƒíƒœ: ${{ job.status }}"
        echo "íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "PR ì œëª©: ${{ github.event.pull_request.title }}"
          echo "PR ì‘ì„±ì: ${{ github.event.pull_request.user.login }}"
        fi
        echo "ì™„ë£Œ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
        echo "========================================="
